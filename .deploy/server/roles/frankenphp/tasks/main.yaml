- name: Download and install FrankenPHP
  ansible.builtin.shell: |
    curl -fsSL https://frankenphp.dev/install.sh | sh
  args:
    creates: frankenphp

- name: Move FrankenPHP binary to /usr/bin/
  command: mv frankenphp /usr/bin/frankenphp
  args:
    creates: /usr/bin/frankenphp

- name: Create Caddyfile for FrankenPHP
  copy:
    dest: "/etc/caddy/Caddyfile"
    content: |
      {
          frankenphp
      }
      :80 {
          root * /var/www/html
          php_server
      }

- name: Create systemd service file for FrankenPHP with Caddy
  ansible.builtin.copy:
    dest: /etc/systemd/system/frankenphp-caddy.service
    content: |
      [Unit]
      Description=FrankenPHP with Caddy
      After=network.target

      [Service]
      ExecStart=/usr/bin/frankenphp run --config /etc/caddy/Caddyfile
      WorkingDirectory=/etc/caddy
      User=caddy
      Group=caddy
      Restart=on-failure
      LimitNOFILE=4096

      [Install]
      WantedBy=multi-user.target
  notify:
    - Reload systemd

- name: Set cap_net_bind_service capability on frankenphp
  ansible.builtin.command:
    cmd: setcap cap_net_bind_service=+ep /usr/bin/frankenphp

- name: Reload systemd daemon to pick up new service
  ansible.builtin.systemd:
    daemon_reload: yes

- name: Enable and start FrankenPHP with Caddy service
  ansible.builtin.systemd:
    name: frankenphp-caddy.service
    enabled: yes
    state: started
